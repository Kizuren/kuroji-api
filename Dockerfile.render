FROM node:20-alpine

WORKDIR /app

RUN npm install -g bun

RUN apk add --no-cache git netcat-openbsd

COPY . .

RUN bun install

CMD sh -c "
  if [ -z \"$DATABASE_URL\" ]; then
    echo 'DATABASE_URL is not set!'
    exit 1
  fi

  echo 'Running migrations...'
  bun db:migrate

  echo 'Starting app...'
  bun run prod
"
